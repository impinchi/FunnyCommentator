{% extends "base.html" %}

{% block title %}Edit Server - FunnyCommentator{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="bi bi-pencil"></i> Edit Server: {{ server.name }}
        </h1>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Server Configuration</h5>
            </div>
            <div class="card-body">
                <form method="POST">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="name" class="form-label">Server Name *</label>
                            <input type="text" class="form-control" id="name" name="name" 
                                   value="{{ server.name }}" required placeholder="e.g., My ARK Server">
                            <div class="form-text">Unique name for this server</div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="map_name" class="form-label">Map Name *</label>
                            <select class="form-select" id="map_name" name="map_name" required>
                                <option value="">Select a map...</option>
                                {% set maps = [
                                    "The Island", "The Center", "Scorched Earth", "Ragnarok",
                                    "Aberration", "Extinction", "Valguero", "Genesis: Part 1",
                                    "Crystal Isles", "Genesis: Part 2", "The Lost Island", 
                                    "Fjordur", "Genesis: Ascended"
                                ] %}
                                {% for map in maps %}
                                    <option value="{{ map }}" {% if server.map_name == map %}selected{% endif %}>
                                        {{ map }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="rcon_host" class="form-label">RCON Host</label>
                            <input type="text" class="form-control" id="rcon_host" name="rcon_host" 
                                   value="{{ server.rcon_host }}" placeholder="127.0.0.1">
                            <div class="form-text">IP address of the ARK server</div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="rcon_port" class="form-label">RCON Port</label>
                            <input type="number" class="form-control" id="rcon_port" name="rcon_port" 
                                   value="{{ server.rcon_port }}" min="1" max="65535" placeholder="27015">
                            <div class="form-text">RCON port number</div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="log_file_path" class="form-label">Log File Path (Optional)</label>
                        <input type="text" class="form-control" id="log_file_path" name="log_file_path" 
                               value="{{ server.log_file_path or '' }}"
                               placeholder="F:\asmdata\Servers\Server1\ShooterGame\Saved\Logs\ShooterGame.log">
                        <div class="form-text">
                            Path to ARK server log file for fallback when RCON fails. 
                            <small class="text-muted">Example: F:\asmdata\Servers\YourServer\ShooterGame\Saved\Logs\ShooterGame.log</small>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="max_wild_dino_level" class="form-label">Max Wild Dino Level</label>
                            <input type="number" class="form-control" id="max_wild_dino_level" 
                                   name="max_wild_dino_level" value="{{ server.max_wild_dino_level }}" 
                                   min="1" max="1000" placeholder="150">
                            <div class="form-text">Maximum level for wild dinosaurs</div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="tribe_name" class="form-label">Tribe Name</label>
                            <input type="text" class="form-control" id="tribe_name" name="tribe_name" 
                                   value="{{ server.tribe_name }}" placeholder="e.g., Alpha Tribe">
                            <div class="form-text">Main tribe name on this server</div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="player_names" class="form-label">Player Names</label>
                        <input type="text" class="form-control" id="player_names" name="player_names" 
                               value="{{ server.player_names | join(', ') }}" 
                               placeholder="Player1, Player2, Player3">
                        <div class="form-text">Comma-separated list of player names</div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="is_pve" name="is_pve"
                                   {% if server.is_pve %}checked{% endif %}>
                            <label class="form-check-label" for="is_pve">
                                PvE Server
                            </label>
                            <div class="form-text">Check if this is a PvE (Player vs Environment) server</div>
                        </div>
                    </div>
                    
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle"></i> Update Server
                        </button>
                        <a href="{{ url_for('servers') }}" class="btn btn-secondary">
                            <i class="bi bi-x-circle"></i> Cancel
                        </a>
                        <button type="button" class="btn btn-outline-danger" 
                                onclick="confirmDelete('{{ server.name }}')">
                            <i class="bi bi-trash"></i> Delete Server
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-info-circle"></i> Current Configuration
                </h5>
            </div>
            <div class="card-body">
                <dl class="row">
                    <dt class="col-sm-5">Map:</dt>
                    <dd class="col-sm-7">{{ server.map_name }}</dd>
                    
                    <dt class="col-sm-5">Type:</dt>
                    <dd class="col-sm-7">
                        <span class="badge {{ 'bg-success' if server.is_pve else 'bg-warning' }}">
                            {{ 'PvE' if server.is_pve else 'PvP' }}
                        </span>
                    </dd>
                    
                    <dt class="col-sm-5">Connection:</dt>
                    <dd class="col-sm-7">{{ server.rcon_host }}:{{ server.rcon_port }}</dd>
                    
                    <dt class="col-sm-5">Max Level:</dt>
                    <dd class="col-sm-7">{{ server.max_wild_dino_level }}</dd>
                    
                    <dt class="col-sm-5">Tribe:</dt>
                    <dd class="col-sm-7">{{ server.tribe_name }}</dd>
                </dl>
                
                <h6 class="mt-3">Players ({{ server.player_names | length }})</h6>
                <div>
                    {% for player in server.player_names %}
                        <span class="badge bg-light text-dark me-1 mb-1">{{ player }}</span>
                    {% endfor %}
                </div>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-shield-lock"></i> Security Note
                </h5>
            </div>
            <div class="card-body">
                <p class="small">
                    <i class="bi bi-info-circle text-info"></i>
                    RCON passwords are managed separately in the 
                    <a href="{{ url_for('credentials') }}">Credentials</a> section 
                    for enhanced security.
                </p>
                
                <p class="small text-muted">
                    Changing the server name here will require updating the 
                    corresponding RCON password entry in the credential store.
                </p>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-question-circle"></i> Need Help?
                </h5>
            </div>
            <div class="card-body">
                <h6>Common Settings</h6>
                <ul class="small">
                    <li><strong>The Island:</strong> Classic ARK experience</li>
                    <li><strong>Ragnarok:</strong> Large diverse map</li>
                    <li><strong>Genesis:</strong> Mission-based gameplay</li>
                </ul>
                
                <h6 class="mt-3">RCON Ports</h6>
                <p class="small">
                    Default RCON ports are usually the game port + 5. 
                    For example, if your game port is 7777, RCON port is typically 7782.
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete the server "<span id="serverName"></span>"?</p>
                <p class="text-danger">
                    <i class="bi bi-exclamation-triangle"></i>
                    This action cannot be undone. All configuration for this server will be lost.
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form id="deleteForm" method="POST" style="display: inline;">
                    <button type="submit" class="btn btn-danger">Delete Server</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
function confirmDelete(serverName) {
    document.getElementById('serverName').textContent = serverName;
    document.getElementById('deleteForm').action = '/servers/delete/' + encodeURIComponent(serverName);
    
    const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
    modal.show();
}

// Form validation and helper functions
document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form');
    const nameInput = document.getElementById('name');
    const playerNamesInput = document.getElementById('player_names');
    
    // Add real-time validation feedback
    nameInput.addEventListener('input', function() {
        if (this.value.trim().length < 3) {
            this.setCustomValidity('Server name must be at least 3 characters long');
        } else {
            this.setCustomValidity('');
        }
    });
    
    // Format player names on blur
    playerNamesInput.addEventListener('blur', function() {
        if (this.value) {
            // Clean up the comma-separated list
            const names = this.value.split(',')
                .map(name => name.trim())
                .filter(name => name.length > 0);
            this.value = names.join(', ');
        }
    });
    
    // Warn about server name changes
    const originalName = nameInput.value;
    nameInput.addEventListener('change', function() {
        if (this.value !== originalName) {
            FunnyCommentator.showToast(
                'Changing the server name will require updating the RCON password in the Credentials section.',
                'warning'
            );
        }
    });
});
</script>
{% endblock %}
